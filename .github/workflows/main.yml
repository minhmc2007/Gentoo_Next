name: Build Gentoo Next ISO
on:
  workflow_dispatch: # Button to manually trigger
  push:
    branches: [ "main" ]

jobs:
  build-iso:
    runs-on: ubuntu-latest
    # specific container needed for mounting/squashing capabilities
    container:
      image: ubuntu:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Tools
      run: |
        apt-get update
        apt-get install -y wget squashfs-tools xorriso sed curl file

    - name: Download Latest Gentoo ISO (Auto-Detect)
      run: |
        echo "ðŸ” Checking Gentoo servers for the latest Minimal ISO..."
        
        # Define the directory where Gentoo stores daily/weekly builds
        BASE_URL="https://distfiles.gentoo.org/releases/amd64/autobuilds"
        
        # Read the text file that points to the current valid ISO
        # This handles the "20251122T..." folder rotation automatically
        ISO_REL_PATH=$(curl -s "${BASE_URL}/latest-install-amd64-minimal.txt" | grep -v "^#" | awk '{print $1}' | head -n 1)
        
        if [ -z "$ISO_REL_PATH" ]; then
          echo "âŒ Error: Could not find ISO path. Fallback to hardcoded link..."
          # Emergency fallback if their API is down, using the link you provided
          FULL_URL="https://distfiles.gentoo.org/releases/amd64/autobuilds/20251122T160055Z/install-amd64-minimal-20251122T160055Z.iso"
        else
          FULL_URL="${BASE_URL}/${ISO_REL_PATH}"
        fi
        
        echo "âœ… Target ISO: $FULL_URL"
        
        echo "â¬‡ï¸ Downloading..."
        wget -q --show-progress -O base.iso "$FULL_URL"

    - name: Extract ISO Contents
      run: |
        echo "ðŸ“¦ Extracting ISO structure..."
        xorriso -osirrox on -indev base.iso -extract / iso_content

    - name: Unpack Root Filesystem (SquashFS)
      run: |
        echo "ðŸ”“ Unsquashing root filesystem (this holds the OS)..."
        unsquashfs -d squashfs-root iso_content/image.squashfs
        rm iso_content/image.squashfs

    - name: Inject GPM and Branding
      run: |
        echo "ðŸ’‰ Injecting Gentoo Next customizations..."
        
        # 1. Verify GPM exists in repo
        if [ ! -f gpm ]; then
          echo "âŒ ERROR: 'gpm' file not found in repo root!"
          exit 1
        fi

        # 2. Install GPM to /usr/bin/
        cp gpm squashfs-root/usr/bin/gpm
        chmod +x squashfs-root/usr/bin/gpm
        
        # 3. Create necessary directories for GPM
        mkdir -p squashfs-root/etc/gpm
        mkdir -p squashfs-root/var/log/gpm
        mkdir -p squashfs-root/var/cache/gpm
        
        # 4. BRANDING: Update /etc/os-release
        # This makes the system identify as Gentoo Next
        if [ -f squashfs-root/etc/os-release ]; then
          sed -i 's/^NAME=.*/NAME="Gentoo Next"/' squashfs-root/etc/os-release
          sed -i 's/^PRETTY_NAME=.*/PRETTY_NAME="Gentoo Next (GPM Edition)"/' squashfs-root/etc/os-release
          sed -i 's/^ID=.*/ID=gentoo-next/' squashfs-root/etc/os-release
        fi

        # 5. BRANDING: Update MOTD (Message shown on login)
        echo -e "\n\033[1;35mWelcome to Gentoo Next\033[0m" > squashfs-root/etc/motd
        echo "Powered by GPM Package Manager" >> squashfs-root/etc/motd
        echo "Run 'gpm help' to get started." >> squashfs-root/etc/motd
        echo "" >> squashfs-root/etc/motd
        
        # 6. Create a default GPM config
        echo "CORES=auto" > squashfs-root/etc/gpm/config
        echo "SAFE_MODE=true" >> squashfs-root/etc/gpm/config

    - name: Repack Root Filesystem
      run: |
        echo "ðŸ”’ Compressing filesystem back to SquashFS..."
        # -comp xz gives best compression (small ISO) but takes CPU
        mksquashfs squashfs-root iso_content/image.squashfs -comp xz -noappend

    - name: Build Final Bootable ISO
      run: |
        echo "ðŸ’¿ Generating .iso file..."
        cd iso_content
        
        xorriso -as mkisofs \
           -iso-level 3 \
           -full-iso9660-filenames \
           -volid "GENTOO_NEXT" \
           -eltorito-boot isolinux/isolinux.bin \
           -eltorito-catalog isolinux/boot.cat \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
           -output ../gentoo-next.iso \
           . \
        || \
        # Fallback if ISOLINUX path varies
        xorriso -as mkisofs \
           -r -J -joliet-long \
           -l -iso-level 3 \
           -V "GENTOO_NEXT" \
           -b isolinux/isolinux.bin \
           -c isolinux/boot.cat \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -o ../gentoo-next.iso \
           .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-iso
        path: gentoo-next.iso
        retention-days: 3
