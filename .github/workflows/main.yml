name: Build Gentoo Next ISO
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Tools
      run: |
        apt-get update
        # Added 'isolinux' and 'syslinux-common' to fix the "path does not exist on disk" error
        apt-get install -y wget squashfs-tools xorriso sed file isolinux syslinux-common

    - name: Download Base Gentoo ISO
      run: |
        echo "Downloading specific ISO version..."
        # Using the link you provided
        wget -q --show-progress -O base.iso "https://distfiles.gentoo.org/releases/amd64/autobuilds/20251122T160055Z/install-amd64-minimal-20251122T160055Z.iso"

    - name: Extract ISO Contents
      run: |
        echo "Extracting ISO structure..."
        xorriso -osirrox on -indev base.iso -extract / iso_content

    - name: Unpack Root Filesystem
      run: |
        echo "Unsquashing root filesystem..."
        unsquashfs -d squashfs-root iso_content/image.squashfs
        rm iso_content/image.squashfs

    - name: Inject GPM and Branding
      run: |
        echo "Injecting Gentoo Next customizations..."
        
        if [ ! -f gpm ]; then
          echo "ERROR: 'gpm' file not found in repo root!"
          exit 1
        fi

        # Install GPM
        cp gpm squashfs-root/usr/bin/gpm
        chmod +x squashfs-root/usr/bin/gpm
        
        # Create directories
        mkdir -p squashfs-root/etc/gpm
        mkdir -p squashfs-root/var/log/gpm
        mkdir -p squashfs-root/var/cache/gpm
        
        # Branding: OS Release
        if [ -f squashfs-root/etc/os-release ]; then
          sed -i 's/^NAME=.*/NAME="Gentoo Next"/' squashfs-root/etc/os-release
          sed -i 's/^PRETTY_NAME=.*/PRETTY_NAME="Gentoo Next (GPM Edition)"/' squashfs-root/etc/os-release
          sed -i 's/^ID=.*/ID=gentoo-next/' squashfs-root/etc/os-release
        fi

        # Branding: MOTD
        echo "" > squashfs-root/etc/motd
        echo "Welcome to Gentoo Next" >> squashfs-root/etc/motd
        echo "Powered by GPM Package Manager" >> squashfs-root/etc/motd
        echo "Run 'gpm help' to get started." >> squashfs-root/etc/motd
        echo "" >> squashfs-root/etc/motd
        
        # Config
        echo "CORES=auto" > squashfs-root/etc/gpm/config
        echo "SAFE_MODE=true" >> squashfs-root/etc/gpm/config

    - name: Repack Root Filesystem
      run: |
        echo "Compressing filesystem back to SquashFS..."
        # Using gzip for faster speed (xz is better but slower), to avoid timeout
        mksquashfs squashfs-root iso_content/image.squashfs -comp gzip -noappend

    - name: Detect Bootloader and Build ISO
      run: |
        echo "Detecting bootloader location..."
        cd iso_content
        
        # Find where isolinux.bin is hiding
        BOOT_BIN=$(find . -name isolinux.bin | head -n 1 | sed 's|^\./||')
        BOOT_CAT=$(find . -name boot.cat | head -n 1 | sed 's|^\./||')
        
        if [ -z "$BOOT_BIN" ]; then
          echo "CRITICAL ERROR: Could not find isolinux.bin in extracted ISO."
          echo "File structure:"
          find . -maxdepth 3
          exit 1
        fi
        
        echo "Found bootloader at: $BOOT_BIN"
        echo "Found catalog at: $BOOT_CAT"
        
        echo "Building ISO..."
        
        xorriso -as mkisofs \
           -iso-level 3 \
           -full-iso9660-filenames \
           -volid "GENTOO_NEXT" \
           -eltorito-boot "$BOOT_BIN" \
           -eltorito-catalog "$BOOT_CAT" \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
           -output ../gentoo-next.iso \
           .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-iso
        path: gentoo-next.iso
        retention-days: 5
