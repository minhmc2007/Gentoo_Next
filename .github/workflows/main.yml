name: Build Gentoo Linux Next (Alpine Builder)
on:
  workflow_dispatch:
    inputs:
      create_release:
        type: boolean
        description: 'Upload to Releases?'
        default: false

permissions:
  contents: write

jobs:
  build-full:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Dependencies (Alpine)
      run: |
        echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
        echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
        apk update
        
        # FIX: Added 'linux-headers' (Fixes asm/types.h error)
        # FIX: Added 'gawk' (Kernel makefiles prefer GNU awk)
        # FIX: Added 'ncurses-dev' (Useful for menuconfig/tools)
        apk add --no-cache \
          bash build-base git wget curl xz cpio \
          bison flex elfutils-dev openssl-dev \
          linux-headers gawk ncurses-dev \
          squashfs-tools xorriso grub grub-bios grub-efi mtools dosfstools \
          dracut kmod jq sed

    - name: Prepare Workspace
      run: |
        mkdir -p build_area
        mkdir -p modules_stage
        mkdir -p iso_build/boot/grub
        mkdir -p iso_build/LiveOS

    # --- PART 1: GET STAGE 3 ROOTFS ---
    - name: Download & Unpack Stage 3
      run: |
        echo "Downloading Gentoo Stage 3 OpenRC..."
        wget -q --show-progress -O stage3.tar.xz "https://distfiles.gentoo.org/releases/amd64/autobuilds/20251130T164554Z/stage3-amd64-openrc-20251130T164554Z.tar.xz"
        
        echo "Creating Root Filesystem..."
        mkdir -p squashfs-root
        
        echo "Extracting Stage 3..."
        tar xpf stage3.tar.xz -C squashfs-root --numeric-owner
        
        # CLEANUP
        rm -rf squashfs-root/usr/share/doc
        rm -rf squashfs-root/usr/share/man
        rm -rf squashfs-root/var/db/repos/gentoo

    # --- PART 2: APPLY OVERLAY & CONFIG ---
    - name: Configure System
      run: |
        # 1. Apply User Overlay
        if [ -d "overlay" ]; then
          echo "Applying 'overlay/'..."
          cp -ruv overlay/* squashfs-root/
          if [ -f squashfs-root/usr/bin/pkg ]; then
            chmod +x squashfs-root/usr/bin/pkg
          fi
        fi
        
        # 2. Branding
        if [ -f squashfs-root/etc/os-release ]; then
           sed -i 's/^NAME=.*/NAME="Gentoo Linux Next"/' squashfs-root/etc/os-release
           sed -i 's/^PRETTY_NAME=.*/PRETTY_NAME="Gentoo Linux Next"/' squashfs-root/etc/os-release
        fi
        echo "Gentoo Linux Next" > squashfs-root/etc/issue
        
        # 3. ROOT PASSWORD (Force Empty)
        sed -i 's/^root:[^:]*:/root::/' squashfs-root/etc/shadow
        
        # 4. Enable Critical Services
        ln -sf /etc/init.d/udev squashfs-root/etc/runlevels/sysinit/udev || true
        ln -sf /etc/init.d/udev-trigger squashfs-root/etc/runlevels/sysinit/udev-trigger || true

    # --- PART 3: COMPILE CUSTOM KERNEL ---
    - name: Fetch and Compile Kernel
      id: kernel
      run: |
        /bin/bash -c "source /etc/profile"
        
        KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
        echo "version=$KVER" >> $GITHUB_OUTPUT
        
        echo "Downloading Linux $KVER..."
        wget -q "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KVER.tar.xz"
        tar -xf "linux-$KVER.tar.xz"
        cd "linux-$KVER"
        
        if [ -f ../config/kernel/config ]; then
          cp ../config/kernel/config .config
        else
          echo "CRITICAL ERROR: config/kernel/config not found!"
          exit 1
        fi
        
        # FORCE CRITICAL CONFIGS
        bash ./scripts/config --enable CONFIG_OVERLAY_FS
        bash ./scripts/config --enable CONFIG_SQUASHFS
        bash ./scripts/config --enable CONFIG_ISO9660_FS
        bash ./scripts/config --enable CONFIG_BLK_DEV_LOOP
        
        # Disable BPF/BTF to avoid more build errors on Alpine
        bash ./scripts/config --disable CONFIG_DEBUG_INFO_BTF
        bash ./scripts/config --disable CONFIG_BPF
        
        make olddefconfig
        
        echo "Compiling Kernel..."
        make -j$(nproc) bzImage modules
        
        echo "Installing modules..."
        make INSTALL_MOD_PATH=../modules_stage modules_install
        
        cp arch/x86/boot/bzImage ../iso_build/boot/kernel

    # --- PART 4: INTEGRATE KERNEL & DRACUT ---
    - name: Generate Initramfs
      run: |
        FULL_KVER=$(ls modules_stage/lib/modules/ | head -n 1)
        echo "Using Kernel Modules: $FULL_KVER"
        
        # 1. Install Modules into RootFS
        rm -rf squashfs-root/lib/modules/*
        cp -r modules_stage/lib/modules/* squashfs-root/lib/modules/
        
        # 2. Setup Dracut Environment
        mkdir -p /lib/modules
        cp -r modules_stage/lib/modules/$FULL_KVER /lib/modules/
        
        # 3. Depmod
        depmod -a -b / "$FULL_KVER"
        
        # 4. Dracut
        echo "Generating initramfs..."
        dracut --kver "$FULL_KVER" --force -N --xz \
        --omit "systemd systemd-initrd systemd-networkd systemd-udevd lvm mdraid multipath" \
        --add "base bash dmsquash-live pollcdrom busybox" \
        --add-drivers "squashfs loop overlay isofs cdrom sr_mod" \
        iso_build/boot/initramfs.img
        
        echo "full_version=$FULL_KVER" >> $GITHUB_ENV

    # --- PART 5: CONSTRUCT ISO & BOOTLOADER ---
    - name: Configure GRUB & Wallpaper
      run: |
        # 1. Download Wallpaper
        echo "Downloading Wallpaper..."
        wget -q -O iso_build/boot/grub/splash.jpg "https://c4.wallpaperflare.com/wallpaper/897/820/61/gentoo-linux-mint-unix-linux-hd-wallpaper-preview.jpg"
        
        # 2. Create grub.cfg
        echo "Creating grub.cfg..."
        cat <<EOF > iso_build/boot/grub/grub.cfg
        insmod all_video
        insmod gfxterm
        insmod jpeg
        insmod png
        
        background_image /boot/grub/splash.jpg
        set gfxmode=auto
        loadfont unicode
        terminal_output gfxterm
        
        set timeout=10
        set default=0

        menuentry "Gentoo Linux Next" {
            linux /boot/kernel root=live:CDLABEL=GENTOO_NEXT rd.live.image rd.live.overlay console=tty0
            initrd /boot/initramfs.img
        }
        
        menuentry "Gentoo Linux Next (Ramdisk Mode)" {
            linux /boot/kernel root=live:CDLABEL=GENTOO_NEXT rd.live.image rd.live.ram=1 console=tty0
            initrd /boot/initramfs.img
        }
        EOF

    - name: Pack Final ISO
      run: |
        echo "Squashing Root Filesystem..."
        mksquashfs squashfs-root iso_build/LiveOS/rootfs.img -comp gzip -noappend
        
        echo "Generating Hybrid ISO with grub-mkrescue..."
        grub-mkrescue -o gentoo-next.iso iso_build \
          --volid "GENTOO_NEXT" \
          --product-name "Gentoo Linux Next" \
          --product-version "${{ env.full_version }}"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-stage3
        path: gentoo-next.iso

    - name: Create Release
      if: ${{ inputs.create_release == true }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ github.run_number }}-stage3"
        name: "Gentoo Next (From Scratch)"
        body: |
          ### Gentoo Linux Next
          - **Base**: Stage 3 OpenRC
          - **Kernel**: ${{ env.full_version }}
          - **Builder**: Alpine Linux
        files: gentoo-next.iso
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
