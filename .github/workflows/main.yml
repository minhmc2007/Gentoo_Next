name: Build Gentoo Linux Next
on:
  workflow_dispatch:
    inputs:
      create_release:
        type: boolean
        description: 'Upload to Releases?'
        default: false

permissions:
  contents: write

jobs:
  build-full:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Dependencies
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        apt-get install -y --no-install-recommends \
          wget squashfs-tools xorriso sed file \
          build-essential bc bison flex libelf-dev libssl-dev \
          jq curl dracut kmod cpio ca-certificates xz-utils

    - name: Prepare Workspace
      run: |
        mkdir -p build_area
        mkdir -p modules_stage

    # --- PART 1: GET BASE ISO ---
    - name: Download Base Gentoo ISO
      run: |
        echo "Downloading Minimal ISO..."
        wget -q --show-progress -O base.iso "https://distfiles.gentoo.org/releases/amd64/autobuilds/20251122T160055Z/install-amd64-minimal-20251122T160055Z.iso"
        
        echo "Extracting ISO..."
        xorriso -osirrox on -indev base.iso -extract / iso_content
        
        echo "Unpacking SquashFS..."
        unsquashfs -d squashfs-root iso_content/image.squashfs
        rm iso_content/image.squashfs

    # --- PART 2: APPLY OVERLAY ---
    - name: Apply System Overlay
      run: |
        if [ -d "overlay" ]; then
          echo "Applying 'overlay/'..."
          cp -ruv overlay/* squashfs-root/
          if [ -f squashfs-root/usr/bin/pkg ]; then
            chmod +x squashfs-root/usr/bin/pkg
          fi
        else
          echo "WARNING: No 'overlay' folder found."
        fi

    # --- PART 3: COMPILE CUSTOM KERNEL ---
    - name: Fetch and Compile Custom Kernel
      id: kernel
      run: |
        KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
        if [ -z "$KVER" ] || [ "$KVER" == "null" ]; then
             echo "ERROR: Could not fetch kernel version."
             exit 1
        fi
        
        echo "Latest Stable Kernel: $KVER"
        echo "version=$KVER" >> $GITHUB_OUTPUT
        
        echo "Downloading Linux $KVER..."
        wget -q "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KVER.tar.xz"
        tar -xf "linux-$KVER.tar.xz"
        cd "linux-$KVER"
        
        if [ -f ../config/kernel/config ]; then
          echo "Using custom configuration..."
          cp ../config/kernel/config .config
          make olddefconfig
        else
          echo "CRITICAL ERROR: config/kernel/config not found!"
          exit 1
        fi
        
        echo "Compiling Kernel..."
        make -j$(nproc) bzImage modules
        
        echo "Installing modules to staging..."
        make INSTALL_MOD_PATH=../modules_stage modules_install
        
        # Deploy bzImage
        cp arch/x86/boot/bzImage ../iso_content/boot/gentoo

    # --- PART 4: INTEGRATE KERNEL (FIXED) ---
    - name: Integrate New Kernel
      run: |
        # 1. Detect the ACTUAL directory name (Handles localversion suffix)
        FULL_KVER=$(ls modules_stage/lib/modules/ | head -n 1)
        
        echo "Upstream Version: ${{ steps.kernel.outputs.version }}"
        echo "Actual Kernel Dir: $FULL_KVER"
        
        if [ -z "$FULL_KVER" ]; then
            echo "CRITICAL ERROR: No module directory found in stage!"
            exit 1
        fi
        
        # 2. Clean old modules from the SquashFS root
        rm -rf squashfs-root/lib/modules/*
        
        # 3. Inject NEW modules into SquashFS
        echo "Copying modules to rootfs..."
        cp -r modules_stage/lib/modules/* squashfs-root/lib/modules/
        
        # 4. Generate Initramfs
        # Copy modules to the host /lib/modules so dracut can find them
        mkdir -p /lib/modules
        cp -r modules_stage/lib/modules/$FULL_KVER /lib/modules/
        
        echo "Generating initramfs with Dracut..."
        # We must use FULL_KVER here so dracut looks in the right folder
        dracut --kver "$FULL_KVER" --force -N --xz \
        --add "base dmsquash-live pollcdrom" \
        --omit "lvm mdraid" \
        iso_content/boot/gentoo.igz
        
        # Save the full version to output for the release step
        echo "full_version=$FULL_KVER" >> $GITHUB_ENV

    # --- PART 5: FIX BOOTLOADER ---
    - name: Fix Bootloader Config
      run: |
        ORIG_LABEL=$(xorriso -indev base.iso -pvd_info 2>/dev/null | grep "Volume Id" | sed 's/.*: //' | tr -d ' ')
        if [ -z "$ORIG_LABEL" ]; then ORIG_LABEL="Gentoo-amd64-20251122"; fi
        
        echo "Patching boot configs (Replacing $ORIG_LABEL with GENTOO_NEXT)..."
        find iso_content -type f \( -name "*.cfg" -o -name "*.conf" \) -exec sed -i "s/$ORIG_LABEL/GENTOO_NEXT/g" {} +

    # --- PART 6: PACK ISO ---
    - name: Pack Final ISO
      run: |
        echo "Squashing filesystem..."
        mksquashfs squashfs-root iso_content/image.squashfs -comp gzip -noappend
        
        cd iso_content
        BIOS_IMG=$(find boot/grub -name eltorito.img)
        if [ -z "$BIOS_IMG" ]; then BIOS_IMG=$(find boot/grub/i386-pc -name "*.img" | head -n 1); fi
        UEFI_IMG=$(find . -maxdepth 2 -name efi.img | sed 's|^\./||')
        
        echo "Building ISO..."
        xorriso -as mkisofs \
           -iso-level 3 \
           -full-iso9660-filenames \
           -volid "GENTOO_NEXT" \
           -eltorito-boot "$BIOS_IMG" \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -eltorito-alt-boot \
           -e "$UEFI_IMG" \
           -no-emul-boot -isohybrid-gpt-basdat \
           -output ../gentoo-next.iso \
           .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-custom-kernel
        path: gentoo-next.iso

    - name: Create Release
      if: ${{ inputs.create_release == true }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ github.run_number }}-kernel-${{ env.full_version }}"
        name: "Gentoo Next (Kernel ${{ env.full_version }})"
        body: |
          ### Gentoo Next Custom
          - **Kernel**: ${{ env.full_version }}
          - **Config**: Custom User Config
        files: gentoo-next.iso
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
