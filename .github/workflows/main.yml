name: Build Gentoo Linux Next
on:
  workflow_dispatch:
    inputs:
      create_release:
        type: boolean
        description: 'Upload to Releases?'
        default: false

permissions:
  contents: write

jobs:
  build-full:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Dependencies (Arch)
      run: |
        pacman -Syu --noconfirm
        # We need grub, mtools, and libisoburn to generate the ISO bootloader from scratch
        pacman -S --noconfirm \
          base-devel wget squashfs-tools libisoburn \
          bc libelf openssl jq curl dracut cpio xz git \
          kmod grub mtools dosfstools

    - name: Prepare Workspace
      run: |
        mkdir -p build_area
        mkdir -p modules_stage
        mkdir -p iso_build/boot/grub

    # --- PART 1: GET STAGE 3 ROOTFS ---
    - name: Download & Unpack Stage 3
      run: |
        echo "Downloading Gentoo Stage 3 OpenRC..."
        # Using the specific link you requested
        wget -q --show-progress -O stage3.tar.xz "https://distfiles.gentoo.org/releases/amd64/autobuilds/20251130T164554Z/stage3-amd64-openrc-20251130T164554Z.tar.xz"
        
        echo "Creating Root Filesystem..."
        mkdir -p squashfs-root
        
        echo "Extracting Stage 3 (This preserves permissions)..."
        tar xpf stage3.tar.xz -C squashfs-root --numeric-owner
        
        # CLEANUP: Remove files we don't need for a LiveCD to save space
        rm -rf squashfs-root/usr/share/doc
        rm -rf squashfs-root/usr/share/man
        rm -rf squashfs-root/var/db/repos/gentoo

    # --- PART 2: APPLY OVERLAY & CONFIG ---
    - name: Configure System
      run: |
        # 1. Apply User Overlay
        if [ -d "overlay" ]; then
          echo "Applying 'overlay/'..."
          cp -ruv overlay/* squashfs-root/
          if [ -f squashfs-root/usr/bin/pkg ]; then
            chmod +x squashfs-root/usr/bin/pkg
          fi
        fi
        
        # 2. Branding
        if [ -f squashfs-root/etc/os-release ]; then
           sed -i 's/^NAME=.*/NAME="Gentoo Linux Next"/' squashfs-root/etc/os-release
           sed -i 's/^PRETTY_NAME=.*/PRETTY_NAME="Gentoo Linux Next"/' squashfs-root/etc/os-release
        fi
        echo "Gentoo Linux Next \n \l" > squashfs-root/etc/issue
        
        # 3. ROOT PASSWORD (CRITICAL for Stage 3)
        # Stage 3 has a locked root account. We must unlock it.
        # This command removes the '!' or '*' from shadow, making the password empty.
        sed -i 's/^root:[^:]*:/root::/' squashfs-root/etc/shadow
        
        # 4. Enable Critical Services (OpenRC)
        # Since we are in a container, we just create the symlinks manually
        ln -sf /etc/init.d/udev squashfs-root/etc/runlevels/sysinit/udev || true
        ln -sf /etc/init.d/udev-trigger squashfs-root/etc/runlevels/sysinit/udev-trigger || true

    # --- PART 3: COMPILE CUSTOM KERNEL ---
    - name: Fetch and Compile Kernel
      id: kernel
      run: |
        KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
        echo "version=$KVER" >> $GITHUB_OUTPUT
        
        echo "Downloading Linux $KVER..."
        wget -q "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KVER.tar.xz"
        tar -xf "linux-$KVER.tar.xz"
        cd "linux-$KVER"
        
        if [ -f ../config/kernel/config ]; then
          cp ../config/kernel/config .config
          make olddefconfig
        else
          echo "CRITICAL ERROR: config/kernel/config not found!"
          exit 1
        fi
        
        echo "Compiling Kernel..."
        make -j$(nproc) bzImage modules
        
        echo "Installing modules..."
        make INSTALL_MOD_PATH=../modules_stage modules_install
        
        # Copy kernel to ISO build area
        cp arch/x86/boot/bzImage ../iso_build/boot/kernel

    # --- PART 4: INTEGRATE KERNEL & DRACUT ---
    - name: Generate Initramfs
      run: |
        FULL_KVER=$(ls modules_stage/lib/modules/ | head -n 1)
        echo "Using Kernel Modules: $FULL_KVER"
        
        # 1. Install Modules into RootFS
        rm -rf squashfs-root/lib/modules/*
        cp -r modules_stage/lib/modules/* squashfs-root/lib/modules/
        
        # 2. Setup Dracut Environment
        mkdir -p /lib/modules
        cp -r modules_stage/lib/modules/$FULL_KVER /lib/modules/
        
        # 3. Depmod
        depmod -a -b / "$FULL_KVER"
        
        # 4. Dracut
        echo "Generating initramfs..."
        # We need dmsquash-live to handle the squashfs boot
        dracut --kver "$FULL_KVER" --force -N --xz \
        --omit "systemd systemd-initrd systemd-networkd udev-rules lvm mdraid multipath" \
        --add "base bash dmsquash-live pollcdrom busybox" \
        --add-drivers "squashfs loop overlay isofs cdrom sr_mod" \
        iso_build/boot/initramfs.img
        
        echo "full_version=$FULL_KVER" >> $GITHUB_ENV

    # --- PART 5: CONSTRUCT ISO & BOOTLOADER ---
    - name: Configure GRUB & Wallpaper
      run: |
        # 1. Download Wallpaper
        echo "Downloading Wallpaper..."
        wget -q -O iso_build/boot/grub/splash.jpg "https://c4.wallpaperflare.com/wallpaper/897/820/61/gentoo-linux-mint-unix-linux-hd-wallpaper-preview.jpg"
        
        # 2. Create grub.cfg
        echo "Creating grub.cfg..."
        cat <<EOF > iso_build/boot/grub/grub.cfg
        # Load Modules
        insmod all_video
        insmod gfxterm
        insmod jpeg
        insmod png
        
        # Theme Setup
        background_image /boot/grub/splash.jpg
        set gfxmode=auto
        loadfont unicode
        terminal_output gfxterm
        
        # Timeout
        set timeout=10
        set default=0

        menuentry "Gentoo Linux Next" {
            linux /boot/kernel root=live:CDLABEL=GENTOO_NEXT rd.live.image rd.live.overlay console=tty0
            initrd /boot/initramfs.img
        }
        
        menuentry "Gentoo Linux Next (Ramdisk Mode)" {
            linux /boot/kernel root=live:CDLABEL=GENTOO_NEXT rd.live.image rd.live.ram=1 console=tty0
            initrd /boot/initramfs.img
        }
        EOF

    - name: Pack Final ISO
      run: |
        echo "Squashing Root Filesystem..."
        # Mksquashfs the Stage 3 root into the ISO folder
        mksquashfs squashfs-root iso_build/LiveOS/rootfs.img -comp gzip -noappend
        
        echo "Generating Hybrid ISO with grub-mkrescue..."
        # grub-mkrescue handles the BIOS/EFI magic for us
        grub-mkrescue -o gentoo-next.iso iso_build \
          --volid "GENTOO_NEXT" \
          --product-name "Gentoo Linux Next" \
          --product-version "${{ env.full_version }}"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-stage3
        path: gentoo-next.iso

    - name: Create Release
      if: ${{ inputs.create_release == true }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ github.run_number }}-stage3"
        name: "Gentoo Next (From Scratch)"
        body: |
          ### Gentoo Linux Next
          - **Base**: Stage 3 OpenRC
          - **Kernel**: ${{ env.full_version }}
          - **Build**: From Scratch (grub-mkrescue)
        files: gentoo-next.iso
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
