name: Build Gentoo Next ISO
on:
  workflow_dispatch: # Allows you to manually trigger the build button
  push:
    branches: [ "main" ]

jobs:
  build-iso:
    runs-on: ubuntu-latest
    # We need high privileges to mount/chroot/squash
    container:
      image: ubuntu:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        apt-get update
        apt-get install -y wget squashfs-tools xorriso sed curl sudo

    - name: Download Base Gentoo ISO
      run: |
        # Downloading the latest Gentoo Minimal ISO (approx 400MB)
        echo "Downloading Gentoo Minimal ISO..."
        # Note: We use a specific mirror to ensure link stability.
        wget -O base.iso https://distfiles.gentoo.org/releases/amd64/autobuilds/current-install-amd64-minimal/install-amd64-minimal-20250202T170353Z.iso || wget -O base.iso https://distfiles.gentoo.org/releases/amd64/autobuilds/current-install-amd64-minimal/$(curl -s https://distfiles.gentoo.org/releases/amd64/autobuilds/current-install-amd64-minimal/ | grep -o 'install-amd64-minimal-[0-9TZ]*\.iso' | head -n 1)

    - name: Extract ISO Contents
      run: |
        echo "Extracting ISO structure..."
        xorriso -osirrox on -indev base.iso -extract / iso_content

    - name: Unpack Root Filesystem (SquashFS)
      run: |
        echo "Unsquashing root filesystem..."
        unsquashfs -d squashfs-root iso_content/image.squashfs
        rm iso_content/image.squashfs

    - name: Inject GPM and Branding (Gentoo Next)
      run: |
        echo "Injecting GPM..."
        
        # 1. Install GPM Script
        cp gpm squashfs-root/usr/bin/gpm
        chmod +x squashfs-root/usr/bin/gpm
        
        # 2. Create Config Dirs
        mkdir -p squashfs-root/etc/gpm
        mkdir -p squashfs-root/var/log/gpm
        mkdir -p squashfs-root/var/cache/gpm
        
        # 3. Branding: Change /etc/os-release
        if [ -f squashfs-root/etc/os-release ]; then
          sed -i 's/Gentoo/Gentoo Next/g' squashfs-root/etc/os-release
          sed -i 's/PRETTY_NAME=".*"/PRETTY_NAME="Gentoo Next (GPM Edition)"/' squashfs-root/etc/os-release
        fi

        # 4. Branding: Change the MOTD (Message of the Day)
        echo "" > squashfs-root/etc/motd
        echo "Welcome to Gentoo Next!" >> squashfs-root/etc/motd
        echo "Use 'gpm help' to manage packages." >> squashfs-root/etc/motd
        echo "" >> squashfs-root/etc/motd

    - name: Repack Root Filesystem
      run: |
        echo "Squashing filesystem... (This may take a few minutes)"
        # High compression (xz) saves space
        mksquashfs squashfs-root iso_content/image.squashfs -comp xz -b 1M -noappend

    - name: Build Final ISO
      run: |
        echo "Building Bootable ISO..."
        cd iso_content
        
        # xorriso magic to make it bootable (Hybrid ISO)
        xorriso -as mkisofs \
           -iso-level 3 \
           -full-iso9660-filenames \
           -volid "GENTOO_NEXT" \
           -eltorito-boot isolinux/isolinux.bin \
           -eltorito-catalog isolinux/boot.cat \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
           -output ../gentoo-next.iso \
           . || \
        # Fallback command if the MBR bin is missing in ubuntu path (common issue)
        xorriso -as mkisofs \
           -r -J -joliet-long \
           -l -iso-level 3 \
           -V "GENTOO_NEXT" \
           -b isolinux/isolinux.bin \
           -c isolinux/boot.cat \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -o ../gentoo-next.iso \
           .

    - name: Upload ISO Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-iso
        path: gentoo-next.iso
        retention-days: 5
