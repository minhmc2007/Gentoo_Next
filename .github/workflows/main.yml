name: Build Gentoo Linux Next
on:
  workflow_dispatch:
    inputs:
      create_release:
        type: boolean
        description: 'Upload to Releases?'
        default: false

permissions:
  contents: write

jobs:
  build-full:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      options: --privileged # Required for mounting and kernel stuff

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Dependencies
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        # We need compilers for the kernel and tools for ISO
        apt-get install -y \
          wget squashfs-tools xorriso sed file \
          build-essential bc bison flex libelf-dev libssl-dev \
          jq curl dracut kmod cpio

    - name: Prepare Workspace
      run: |
        mkdir -p build_area
        mkdir -p modules_stage

    # --- PART 1: GET BASE ISO ---
    - name: Download Base Gentoo ISO
      run: |
        echo "Downloading Minimal ISO..."
        wget -q --show-progress -O base.iso "https://distfiles.gentoo.org/releases/amd64/autobuilds/20251122T160055Z/install-amd64-minimal-20251122T160055Z.iso"
        
        echo "Extracting ISO..."
        xorriso -osirrox on -indev base.iso -extract / iso_content
        
        echo "Unpacking SquashFS..."
        unsquashfs -d squashfs-root iso_content/image.squashfs
        rm iso_content/image.squashfs

    # --- PART 2: APPLY OVERLAY (AiRootFS style) ---
    - name: Apply System Overlay
      run: |
        echo "Applying 'overlay/' directory to root filesystem..."
        
        if [ -d "overlay" ]; then
          # cp -r with update flag to overwrite files
          cp -ruv overlay/* squashfs-root/
          
          # Fix permissions for binaries in the overlay
          if [ -f squashfs-root/usr/bin/gn ]; then
            chmod +x squashfs-root/usr/bin/gn
          fi
          
          echo "Overlay applied."
        else
          echo "WARNING: No 'overlay' folder found in repo!"
        fi

    # --- PART 3: COMPILE CUSTOM KERNEL ---
    - name: Fetch and Compile Latest Kernel
      id: kernel
      run: |
        # 1. Get Latest Version
        KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
        echo "Latest Stable Kernel: $KVER"
        echo "version=$KVER" >> $GITHUB_OUTPUT
        
        # 2. Download Source
        echo "Downloading Kernel Source..."
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KVER.tar.xz
        tar -xf linux-$KVER.tar.xz
        cd linux-$KVER
        
        # 3. Configure
        if [ -f ../config/kernel/config ]; then
          echo "Using custom configuration..."
          cp ../config/kernel/config .config
          # Update config for new version defaults without asking
          make olddefconfig
        else
          echo "ERROR: config/kernel/config not found! Cannot build custom kernel."
          exit 1
        fi
        
        # 4. Compile (This takes time!)
        echo "Compiling Kernel (using $(nproc) cores)..."
        make -j$(nproc) bzImage modules
        
        # 5. Install Modules to Staging Area
        echo "Installing Modules..."
        # We install to a temp dir first so we don't mess up the host runner
        make INSTALL_MOD_PATH=../../modules_stage modules_install
        
        # 6. Move Kernel Image to ISO Boot
        echo "Deploying Kernel to ISO..."
        cp arch/x86/boot/bzImage ../iso_content/boot/gentoo

    # --- PART 4: INTEGRATE KERNEL & INITRAMFS ---
    - name: Integrate New Kernel
      run: |
        KVER="${{ steps.kernel.outputs.version }}"
        echo "Integrating Kernel $KVER..."
        
        # 1. Clean old modules from SquashFS
        echo "Removing old Gentoo modules..."
        rm -rf squashfs-root/lib/modules/*
        
        # 2. Inject NEW modules
        echo "Injecting new modules..."
        cp -r modules_stage/lib/modules/* squashfs-root/lib/modules/
        
        # 3. Generate Initramfs (Dracut)
        # We need to temporarily put modules in the host for dracut to find them
        echo "Generating Initramfs (gentoo.igz)..."
        mkdir -p /lib/modules
        cp -r modules_stage/lib/modules/$KVER /lib/modules/
        
        # Run Dracut to build the initramfs
        # --force: overwrite existing
        # --kver: specify the version we just built
        # -N: No host-specific config (make it generic)
        dracut --kver $KVER --force -N --xz iso_content/boot/gentoo.igz

    # --- PART 5: FIX BOOTLOADER CONFIG ---
    - name: Fix Bootloader Config
      run: |
        echo "Updating Bootloader Label..."
        # Find original label to replace
        ORIG_LABEL=$(xorriso -indev base.iso -pvd_info 2>/dev/null | grep "Volume Id" | sed 's/.*: //' | tr -d ' ')
        if [ -z "$ORIG_LABEL" ]; then ORIG_LABEL="Gentoo-amd64-20251122"; fi
        
        # Replace label with GENTOO_NEXT in all config files
        find iso_content -type f \( -name "*.cfg" -o -name "*.conf" \) -exec sed -i "s/$ORIG_LABEL/GENTOO_NEXT/g" {} +

    # --- PART 6: PACK ISO ---
    - name: Pack Final ISO
      run: |
        echo "Squashing Filesystem..."
        mksquashfs squashfs-root iso_content/image.squashfs -comp gzip -noappend
        
        echo "Building GRUB Hybrid ISO..."
        cd iso_content
        
        # Detect Boot Images
        BIOS_IMG=$(find boot/grub -name eltorito.img)
        if [ -z "$BIOS_IMG" ]; then BIOS_IMG=$(find boot/grub/i386-pc -name "*.img" | head -n 1); fi
        UEFI_IMG=$(find . -maxdepth 2 -name efi.img | sed 's|^\./||')
        
        xorriso -as mkisofs \
           -iso-level 3 \
           -full-iso9660-filenames \
           -volid "GENTOO_NEXT" \
           -eltorito-boot "$BIOS_IMG" \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -eltorito-alt-boot \
           -e "$UEFI_IMG" \
           -no-emul-boot -isohybrid-gpt-basdat \
           -output ../gentoo-next.iso \
           .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-custom-kernel
        path: gentoo-next.iso

    - name: Create Release
      if: ${{ inputs.create_release == true }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ github.run_number }}-kernel-${{ steps.kernel.outputs.version }}"
        name: "Gentoo Next (Kernel ${{ steps.kernel.outputs.version }})"
        body: |
          ### Gentoo Next Custom
          - **Kernel**: ${{ steps.kernel.outputs.version }}
          - **Wifi Support**: Custom Config
        files: gentoo-next.iso
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
