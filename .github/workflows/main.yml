name: Build Gentoo Next ISO
on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Upload to GitHub Releases?'
        required: true
        type: boolean
        default: false
      release_tag:
        description: 'Release Tag (e.g. v1.0-beta)'
        required: false
        default: 'nightly-build'

permissions:
  contents: write

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      options: --privileged

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Tools
      run: |
        apt-get update
        apt-get install -y wget squashfs-tools xorriso sed file

    - name: Download Base Gentoo ISO
      run: |
        echo "Downloading specific ISO version..."
        wget -q --show-progress -O base.iso "https://distfiles.gentoo.org/releases/amd64/autobuilds/20251122T160055Z/install-amd64-minimal-20251122T160055Z.iso"

    - name: Extract ISO Contents
      run: |
        echo "Extracting ISO structure..."
        xorriso -osirrox on -indev base.iso -extract / iso_content

    - name: Fix Bootloader Label (CRITICAL FIX)
      run: |
        echo "ðŸ”§ Patching GRUB config to match new Label..."
        
        # 1. Detect the label of the ORIGINAL ISO using xorriso
        # This gets "Gentoo-amd64-20251122" automatically
        ORIG_LABEL=$(xorriso -indev base.iso -pvd_info 2>/dev/null | grep "Volume Id" | sed 's/.*: //' | tr -d ' ')
        
        if [ -z "$ORIG_LABEL" ]; then
          echo "âš ï¸ Could not auto-detect label. Using fallback."
          ORIG_LABEL="Gentoo-amd64-20251122"
        fi
        
        echo "Original Label found: '$ORIG_LABEL'"
        echo "Replacing with:       'GENTOO_NEXT'"
        
        # 2. Find all config files inside the ISO and replace the old label
        # This updates 'root=live:CDLABEL=...' and 'search --label ...'
        find iso_content -type f \( -name "*.cfg" -o -name "*.conf" \) -exec sed -i "s/$ORIG_LABEL/GENTOO_NEXT/g" {} +
        
        echo "âœ… GRUB/Bootloader config files patched."

    - name: Unpack Root Filesystem
      run: |
        echo "Unsquashing root filesystem..."
        unsquashfs -d squashfs-root iso_content/image.squashfs
        rm iso_content/image.squashfs

    - name: Inject GPM and Branding
      run: |
        if [ ! -f gpm ]; then
          echo "ERROR: 'gpm' file not found in repo root!"
          exit 1
        fi

        # Install GPM
        cp gpm squashfs-root/usr/bin/gpm
        chmod +x squashfs-root/usr/bin/gpm
        
        # Branding
        if [ -f squashfs-root/etc/os-release ]; then
          sed -i 's/^NAME=.*/NAME="Gentoo Next"/' squashfs-root/etc/os-release
          sed -i 's/^PRETTY_NAME=.*/PRETTY_NAME="Gentoo Next (GPM Edition)"/' squashfs-root/etc/os-release
          sed -i 's/^ID=.*/ID=gentoo-next/' squashfs-root/etc/os-release
        fi

        # Directories & MOTD
        mkdir -p squashfs-root/etc/gpm squashfs-root/var/log/gpm squashfs-root/var/cache/gpm
        echo -e "\nWelcome to Gentoo Next\nPowered by GPM\n" > squashfs-root/etc/motd
        echo "CORES=auto" > squashfs-root/etc/gpm/config

    - name: Repack Root Filesystem
      run: |
        echo "Compressing filesystem (gzip)..."
        mksquashfs squashfs-root iso_content/image.squashfs -comp gzip -noappend

    - name: Build Final Bootable ISO (GRUB Hybrid)
      run: |
        cd iso_content
        
        BIOS_IMG=$(find boot/grub -name eltorito.img)
        if [ -z "$BIOS_IMG" ]; then
           BIOS_IMG=$(find boot/grub/i386-pc -name "*.img" | head -n 1)
        fi
        
        UEFI_IMG=$(find . -maxdepth 2 -name efi.img | sed 's|^\./||')
        
        echo "Building GRUB Hybrid ISO..."
        xorriso -as mkisofs \
           -iso-level 3 \
           -full-iso9660-filenames \
           -volid "GENTOO_NEXT" \
           -eltorito-boot "$BIOS_IMG" \
           -no-emul-boot -boot-load-size 4 -boot-info-table \
           -eltorito-alt-boot \
           -e "$UEFI_IMG" \
           -no-emul-boot -isohybrid-gpt-basdat \
           -output ../gentoo-next.iso \
           .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gentoo-next-iso
        path: gentoo-next.iso
        retention-days: 3

    - name: Create Release
      if: ${{ inputs.create_release == true }}
      uses: softprops/action-gh-release@v1
      with:
        name: "Build by GH Action (${{ inputs.release_tag }})"
        tag_name: "v${{ github.run_number }}-${{ inputs.release_tag }}"
        body: |
          ### Gentoo Next
          Fixed boot label issue.
        files: gentoo-next.iso
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
